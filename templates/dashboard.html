{% extends 'base.html' %}
{% block content %}

	<section class="dash-grid">
		<div class="dash-side">
			<h3>Menu</h3>
			<a href="#" class="side-link active" data-tab="code">Code</a>
			<a href="#" class="side-link" data-tab="upload">Upload</a>
			<a href="#" class="side-link" data-tab="history">History</a>
		</div>
		<div class="dash-main">
			<section id="code-section" class="card">
				<h2>Code Analysis</h2>
				<form id="analyze-form" method="POST" action="{{ url_for('detect_enhanced') }}" class="form">
					<div class="language-display">
						<span class="language-label">Programming Language:</span>
						{% if detected_language %}
							<span class="detected-language">{{ detected_language|title }}{% if detected_source %} ({{ detected_source }}){% endif %}</span>
						{% else %}
							<span class="detected-language">Auto-detecting...</span>
						{% endif %}
					</div>
					<input type="hidden" id="language-input" name="language" value="{{ detected_language or 'auto' }}">
					<label>
						<span>Paste your code</span>
						<textarea id="code-input" name="code" rows="14" placeholder="Paste code here..." maxlength="10000">{{ code_input or '' }}</textarea>
						<div class="input-counter">
							<span id="char-count">0</span> / 10,000 characters
						</div>
					</label>
					<div class="actions">
						<button id="analyze-btn" class="button primary" type="submit">Analyze</button>
						<button id="clear-btn" class="button" type="button">Clear</button>
						<span id="analyze-hint" class="muted">Paste code to enable</span>
						{% if detected_language %}
							<span id="detected-badge" class="badge" title="Auto-detected language">Detected: {{ detected_language }}{% if detected_source %} ({{ detected_source }}){% endif %}</span>
						{% else %}
							<span id="detected-badge" class="badge hidden"></span>
						{% endif %}
					</div>
				</form>
				<!-- Analysis Results Section -->
				<div style="margin-top: 2rem;">
				{% if enhanced_result %}
				<div id="enhanced-result-card" class="result-card feedback {% if 'AI' in enhanced_result.final_prediction.label %}is-ai{% elif 'Human' in enhanced_result.final_prediction.label %}is-human{% else %}is-uncertain{% endif %}">
					<h3>Enhanced Code Analysis Result</h3>
					<p class="score">Score: {{ '%.1f'|format(enhanced_result.final_prediction.score) }} / 100 ({{ enhanced_result.final_prediction.score|int }}%) — {{ enhanced_result.final_prediction.label }}</p>
					<p class="confidence">Confidence: {{ '%.1f'|format(enhanced_result.final_prediction.confidence * 100) }}%</p>
					{% if enhanced_result.enhanced_analysis.highlighted_html %}
					<details open>
						<summary>Highlighted Indicators</summary>
						<div class="legend" style="margin:6px 0 10px 0;">
							<span class="legend-item"><span class="swatch hl-ai"></span> AI indicators</span>
							<span class="legend-item" style="margin-left:12px;"><span class="swatch hl-human"></span> Human indicators</span>
						</div>
						<div class="code-view" style="overflow:auto; max-height:380px;">
							{{ enhanced_result.enhanced_analysis.highlighted_html | safe }}
						</div>
					</details>
					{% endif %}
					
					<details open>
						<summary>Method Breakdown</summary>
						<ul>
							<li>Basic Analysis: {{ '%.1f'|format(enhanced_result.final_prediction.method_breakdown.basic) }}%</li>
							<li>Deep Learning: {{ '%.1f'|format(enhanced_result.final_prediction.method_breakdown.deep_learning) }}%</li>
							<li>Enhanced Patterns: {{ '%.1f'|format(enhanced_result.final_prediction.method_breakdown.enhanced) }}%</li>
						</ul>
					</details>
					
					{% if enhanced_result.enhanced_analysis and enhanced_result.enhanced_analysis.pattern_matches %}
					<details>
						<summary>Pattern Analysis</summary>
						{% if enhanced_result.enhanced_analysis.pattern_matches.ai_indicators %}
						<p><strong>AI Indicators:</strong> {{ enhanced_result.enhanced_analysis.pattern_matches.ai_indicators|length }} found</p>
						{% endif %}
						{% if enhanced_result.enhanced_analysis.pattern_matches.human_indicators %}
						<p><strong>Human Indicators:</strong> {{ enhanced_result.enhanced_analysis.pattern_matches.human_indicators|length }} found</p>
						{% endif %}
						{% if enhanced_result.enhanced_analysis.llm_model_prediction %}
						<p><strong>Predicted LLM Model:</strong> {{ enhanced_result.enhanced_analysis.llm_model_prediction }}</p>
						{% endif %}
					</details>
					{% endif %}
					
					{% if enhanced_result.enhanced_analysis and enhanced_result.enhanced_analysis.code_metrics %}
					<details>
						<summary>Code Metrics</summary>
						<ul>
							<li>Total lines: {{ enhanced_result.enhanced_analysis.code_metrics.total_lines }}</li>
							<li>Functions: {{ enhanced_result.enhanced_analysis.code_metrics.function_count }}</li>
							<li>Classes: {{ enhanced_result.enhanced_analysis.code_metrics.class_count }}</li>
							<li>Imports: {{ enhanced_result.enhanced_analysis.code_metrics.import_count }}</li>
							<li>Complexity: {{ '%.1f'|format(enhanced_result.enhanced_analysis.code_metrics.complexity_score) }}</li>
						</ul>
					</details>
					{% endif %}
				</div>
				{% endif %}

				{% if why_human_reasons and why_human_reasons|length > 0 %}
				<div id="why-human-card" class="result-card">
					<h3>Why Human</h3>
					<ul style="margin: 8px 0 0 18px;">
						{% for reason in why_human_reasons %}
						<li>{{ reason }}</li>
						{% endfor %}
					</ul>
				</div>
				{% endif %}
				</div>
			</section>

			<!-- Text Analysis section removed -->

			<section id="upload-section" class="card hidden" style="display: none !important;">
				<h2>File Upload</h2>
				<div class="upload-info">
					<p>Upload code files for analysis. Supported formats:</p>
					<div class="file-types">
						<span class="file-type">Python (.py)</span>
						<span class="file-type">Java (.java)</span>
					</div>
				</div>
				
				<form method="POST" action="{{ url_for('upload_file') }}" enctype="multipart/form-data" class="form">
					<label>
						<span>Select File:</span>
						<input type="file" name="file" accept=".py,.java" required>
					</label>
					<div class="actions">
						<button type="submit" class="button primary">Upload File</button>
					</div>
				</form>

				{% if uploaded_files %}
				<div class="uploaded-files">
					<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
						<h3 style="margin: 0;">Recently Uploaded Files</h3>
						<form method="POST" action="{{ url_for('clear_uploaded_files') }}" style="margin: 0;">
							<button type="submit" class="button" onclick="return confirm('Are you sure you want to clear all uploaded files? This action cannot be undone.')">Clear All Files</button>
						</form>
					</div>
					<ul class="file-list">
					{% for file in uploaded_files %}
						<li class="file-item" id="file-item-{{ file.id }}">
							<div class="file-info">
								<span class="file-name">{{ file.original_filename }}</span>
								<span class="file-meta">{{ file.file_type }} • {{ (file.file_size / 1024)|round(1) }} KB • {{ file.created_at }}</span>
							</div>
							<div class="file-actions">
								<button class="button small" data-content="{{ file.content|replace('\n', '\\n')|replace("'", "\\'") }}" data-type="{{ file.file_type }}" onclick="loadFileContent(this)">Load</button>
								<button class="button small danger" data-file-id="{{ file.id }}" data-file-name="{{ file.original_filename }}" onclick="removeFile(this)">Remove</button>
							</div>
						</li>
					{% endfor %}
					</ul>
				</div>
				{% endif %}
			</section>

			<section id="history-section" class="card hidden" style="display: none !important;">
				<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
					<h3 style="margin: 0;">Recent Analyses</h3>
					<div style="display:flex; gap:8px;">
						<form method="GET" action="{{ url_for('history_latest') }}" style="margin: 0;">
							<button type="submit" class="button">View Latest</button>
						</form>
						<form method="POST" action="{{ url_for('clear_history') }}" style="margin: 0;">
							<button type="submit" class="button" onclick="return confirm('Are you sure you want to clear all analysis history? This action cannot be undone.')">Clear History</button>
						</form>
					</div>
				</div>
				{% if history %}
				<ul class="history">
				{% for h in history %}
					<li class="history-item" id="history-item-{{ h.id }}">
						<div class="history-head">
							<span class="muted">{{ h.language or 'auto' }} • {{ h.created_at }}</span>
							{% if h.original_filename %}
								<span class="file-badge">{{ h.original_filename }}</span>
							{% endif %}
						</div>
						<pre class="history-code">{{ (h.code or '')[:240] }}{% if (h.code or '')|length > 240 %}…{% endif %}</pre>
						<div class="file-actions">
							<a class="button small" href="{{ url_for('history_view', analysis_id=h.id) }}">View</a>
							<button class="button small danger" data-analysis-id="{{ h.id }}" onclick="removeHistory(this.getAttribute('data-analysis-id'))">Remove</button>
						</div>
					</li>
				{% endfor %}
				</ul>
				{% else %}
				<p class="empty-history">No analyses yet. Start by analyzing some code!</p>
				{% endif %}
			</section>
		</div>
	</section>

	<script>
		// Initialize character counter on page load
		document.addEventListener('DOMContentLoaded', function() {
			const codeInput = document.getElementById('code-input');
			const charCountElement = document.getElementById('char-count');
			const charCount = codeInput.value.length;
			charCountElement.textContent = charCount;
			
			// Set initial color
			if (charCount > 9000) {
				charCountElement.style.color = '#ef4444';
			} else if (charCount > 8000) {
				charCountElement.style.color = '#f59e0b';
			} else {
				charCountElement.style.color = '#64748b';
			}
		});

		// Tab switching functionality
		document.querySelectorAll('.side-link').forEach(link => {
			link.addEventListener('click', function(e) {
				e.preventDefault();
				
				// Remove active class from all links
				document.querySelectorAll('.side-link').forEach(l => l.classList.remove('active'));
				
				// Add active class to clicked link
				this.classList.add('active');
				
				// Hide all sections with display: none
			document.querySelectorAll('#code-section, #upload-section, #history-section').forEach(section => {
					section.classList.add('hidden');
					section.style.display = 'none';
				});
				
				// Show corresponding section
				const tab = this.getAttribute('data-tab');
				const activeSection = document.getElementById(tab + '-section');
				if (activeSection) {
					activeSection.classList.remove('hidden');
					activeSection.style.display = '';
				}
				
				// Show/hide results section
				const resultsSection = document.getElementById('results-section');
				if (tab === 'history' || tab === 'upload') {
					if (resultsSection) {
						resultsSection.classList.add('hidden');
						resultsSection.style.display = 'none';
					}
				} else {
					if (resultsSection) {
						resultsSection.classList.remove('hidden');
						resultsSection.style.display = '';
					}
				}
			});
		});

		// Clear button functionality
		document.getElementById('clear-btn').addEventListener('click', function(e) {
			e.preventDefault();
			e.stopPropagation();
			
			// Clear the input fields
			document.getElementById('code-input').value = '';
			document.getElementById('language-input').value = '';
			
			// Reset button states
			document.getElementById('analyze-btn').disabled = true;
			document.getElementById('analyze-hint').classList.remove('hidden');
			document.getElementById('detected-badge').classList.add('hidden');
			
			// Reset character counter
			document.getElementById('char-count').textContent = '0';
			document.getElementById('char-count').style.color = '#64748b';
			
			// Hide all result cards
			document.querySelectorAll('.result-card').forEach(card => {
				card.classList.add('hidden');
			});
			
			// Ensure code section is visible (don't hide it first)
			const codeSection = document.getElementById('code-section');
			if (codeSection) {
				codeSection.classList.remove('hidden');
				codeSection.style.display = '';
			}
			
			// Ensure results section stays visible if it exists
			const resultsSection = document.getElementById('results-section');
			if (resultsSection) {
				resultsSection.classList.remove('hidden');
				resultsSection.style.display = '';
			}
			
			// Switch back to code tab visually
			document.querySelectorAll('.side-link').forEach(l => l.classList.remove('active'));
			const codeLink = document.querySelector('.side-link[data-tab="code"]');
			if (codeLink) {
				codeLink.classList.add('active');
			}
			
			// Hide other sections but keep code section visible
			document.querySelectorAll('#upload-section, #history-section').forEach(section => {
				section.classList.add('hidden');
				section.style.display = 'none';
			});
		});

			// Text UI removed

		// Code input validation
		document.getElementById('code-input').addEventListener('input', function() {
			const code = this.value.trim();
			const analyzeBtn = document.getElementById('analyze-btn');
			const analyzeHint = document.getElementById('analyze-hint');
			
			// Update character counter
			const charCount = this.value.length;
			const charCountElement = document.getElementById('char-count');
			charCountElement.textContent = charCount;
			
			// Change color when approaching limit
			if (charCount > 9000) {
				charCountElement.style.color = '#ef4444'; // red
			} else if (charCount > 8000) {
				charCountElement.style.color = '#f59e0b'; // orange
			} else {
				charCountElement.style.color = '#64748b'; // default gray
			}
			if (code) {
				analyzeBtn.disabled = false;
				analyzeHint.classList.add('hidden');
			} else {
				analyzeBtn.disabled = true;
				analyzeHint.classList.remove('hidden');
			}
		});


		// Text input validation
		// Text validation removed

		// Update language display when language changes
		function updateLanguageDisplay(language, source = 'auto') {
			const languageDisplay = document.querySelector('.detected-language');
			if (languageDisplay) {
				languageDisplay.textContent = language.charAt(0).toUpperCase() + language.slice(1) + (source !== 'auto' ? ` (${source})` : '');
			}
		}

		// Load file content function
		function loadFileContent(button) {
			// Get content and type from data attributes
			const content = button.getAttribute('data-content');
			const fileType = button.getAttribute('data-type');
			
			// Decode the content (handle escaped characters)
			const decodedContent = content.replace(/\\n/g, '\n').replace(/\\'/g, "'");
			
			// Set the code input
			document.getElementById('code-input').value = decodedContent;
			
			// Set the language based on file type
			const languageMap = {
				'py': 'python',
				'java': 'java'
			};
			
			const language = languageMap[fileType] || 'auto';
			document.getElementById('language-input').value = language;
			
			// Update language display
			updateLanguageDisplay(language, 'file');
			
			// Enable analyze button
			document.getElementById('analyze-btn').disabled = false;
			document.getElementById('analyze-hint').classList.add('hidden');
			
			// Switch to code tab
			document.querySelectorAll('.side-link').forEach(l => l.classList.remove('active'));
			const codeLink = document.querySelector('.side-link[data-tab="code"]');
			if (codeLink) codeLink.classList.add('active');
			
			document.querySelectorAll('#code-section, #upload-section, #history-section').forEach(section => {
				section.classList.add('hidden');
				section.style.display = 'none';
			});
			const codeSection = document.getElementById('code-section');
			if (codeSection) {
				codeSection.classList.remove('hidden');
				codeSection.style.display = '';
			}
			const resultsSection = document.getElementById('results-section');
			if (resultsSection) {
				resultsSection.classList.remove('hidden');
				resultsSection.style.display = '';
			}
		}

		// Remove file function
		function removeFile(button) {
			const fileId = button.getAttribute('data-file-id');
			const fileName = button.getAttribute('data-file-name');
			
			if (confirm('Are you sure you want to remove the file "' + fileName + '"? This action cannot be undone.')) {
				fetch('/remove_uploaded_file/' + fileId, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
					},
				})
				.then(response => response.json())
				.then(data => {
					if (data.success) {
						const fileItem = document.getElementById('file-item-' + fileId);
						if (fileItem) {
							fileItem.remove();
						}
						// Show success message
						showMessage('File removed successfully!', 'success');
					} else {
						showMessage('Error removing file: ' + data.message, 'error');
					}
				})
				.catch(error => {
					console.error('Error removing file:', error);
					showMessage('Error removing file: ' + error.message, 'error');
				});
			}
		}

		// Remove history function
		function removeHistory(analysisId) {
			if (!confirm('Remove this history item? This action cannot be undone.')) {
				return;
			}
			fetch('/remove_history/' + analysisId, {
				method: 'POST',
				headers: {
					'Content-Type': 'application/x-www-form-urlencoded',
				},
			})
			.then(response => response.json())
			.then(data => {
				if (data.success) {
					const item = document.getElementById('history-item-' + analysisId);
					if (item) {
						item.remove();
					}
					showMessage('History item removed.', 'success');
				} else {
					showMessage('Error removing history: ' + data.message, 'error');
				}
			})
			.catch(error => {
				console.error('Error removing history:', error);
				showMessage('Error removing history: ' + error.message, 'error');
			});
		}

		// Show message function
		function showMessage(message, type) {
			// Create a temporary message element
			const messageDiv = document.createElement('div');
			messageDiv.className = 'message ' + type;
			messageDiv.textContent = message;
			messageDiv.style.cssText = `
				position: fixed;
				top: 20px;
				right: 20px;
				padding: 12px 20px;
				border-radius: 8px;
				color: white;
				font-weight: 500;
				z-index: 1000;
				background: ${type === 'success' ? '#10b981' : '#ef4444'};
				box-shadow: 0 4px 12px rgba(0,0,0,0.15);
			`;
			
			document.body.appendChild(messageDiv);
			
			// Remove message after 3 seconds
			setTimeout(() => {
				if (messageDiv.parentNode) {
					messageDiv.parentNode.removeChild(messageDiv);
				}
			}, 3000);
		}

		// Initialize page state
		document.addEventListener('DOMContentLoaded', function() {
			// Ensure all sections are properly hidden first
			document.querySelectorAll('#code-section, #upload-section, #history-section').forEach(section => {
				section.classList.add('hidden');
				section.style.display = 'none';
			});
			
			// Check if we're coming from an upload (URL contains upload=success)
			const urlParams = new URLSearchParams(window.location.search);
			const isFromUpload = urlParams.get('upload') === 'success';
			
			if (isFromUpload) {
				// Stay on upload tab if coming from upload
				document.querySelectorAll('.side-link').forEach(l => l.classList.remove('active'));
				const uploadLink = document.querySelector('.side-link[data-tab="upload"]');
				if (uploadLink) uploadLink.classList.add('active');
				
				const uploadSection = document.getElementById('upload-section');
				if (uploadSection) {
					uploadSection.classList.remove('hidden');
					uploadSection.style.display = '';
				}
				const resultsSection = document.getElementById('results-section');
				if (resultsSection) {
					resultsSection.classList.add('hidden');
					resultsSection.style.display = 'none';
				}
			} else {
				// Default state: show code tab
				document.querySelectorAll('.side-link').forEach(l => l.classList.remove('active'));
				const codeLink = document.querySelector('.side-link[data-tab="code"]');
				if (codeLink) codeLink.classList.add('active');
				
				const codeSection = document.getElementById('code-section');
				if (codeSection) {
					codeSection.classList.remove('hidden');
					codeSection.style.display = '';
				}
				const resultsSection = document.getElementById('results-section');
				if (resultsSection) {
					resultsSection.classList.remove('hidden');
					resultsSection.style.display = '';
				}
			}
		});
	</script>
{% endblock %} 